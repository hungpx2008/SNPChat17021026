"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createTable = exports.CreateTableRoute = exports.CREATE_TABLE = exports.tableListVoSchema = exports.tableOpSchema = exports.tablePropertyKeySchema = exports.tableRoWithDefaultSchema = exports.tableRoSchema = exports.tableVoSchema = exports.tableFullVoSchema = void 0;
const core_1 = require("@teable/core");
const axios_1 = require("../axios");
const record_1 = require("../record");
const utils_1 = require("../utils");
const zod_1 = require("../zod");
exports.tableFullVoSchema = zod_1.z
    .object({
    id: zod_1.z.string().startsWith(core_1.IdPrefix.Table).openapi({
        description: 'The id of table.',
    }),
    name: zod_1.z.string().openapi({
        description: 'The name of the table.',
    }),
    dbTableName: zod_1.z
        .string()
        .regex(/^[a-z]\w{0,62}$/i, {
        message: 'Invalid name format',
    })
        .openapi({
        description: 'Table name in backend database. Limitation: 1-63 characters, start with letter, can only contain letters, numbers and underscore, case insensitive, cannot be duplicated with existing db table name in the base.',
    }),
    description: zod_1.z.string().optional().openapi({
        description: 'The description of the table.',
    }),
    icon: zod_1.z.string().emoji().optional().openapi({
        description: 'The emoji icon string of the table.',
    }),
    fields: core_1.fieldVoSchema.array().openapi({
        description: 'The fields of the table.',
    }),
    views: core_1.viewVoSchema.array().openapi({
        description: 'The views of the table.',
    }),
    records: core_1.recordSchema.array().openapi({
        description: 'The records of the table.',
    }),
    order: zod_1.z.number().optional(),
    lastModifiedTime: zod_1.z.string().optional().openapi({
        description: 'The last modified time of the table.',
    }),
    defaultViewId: zod_1.z.string().startsWith(core_1.IdPrefix.View).optional().openapi({
        description: 'The default view id of the table.',
    }),
})
    .openapi({
    description: 'Complete table structure data and initial record data.',
});
exports.tableVoSchema = exports.tableFullVoSchema.omit({
    fields: true,
    views: true,
    records: true,
});
exports.tableRoSchema = exports.tableFullVoSchema
    .omit({
    id: true,
    lastModifiedTime: true,
    defaultViewId: true,
})
    .partial({
    name: true,
    dbTableName: true,
})
    .merge(zod_1.z.object({
    name: exports.tableFullVoSchema.shape.name.min(1).optional(),
    description: exports.tableFullVoSchema.shape.description.nullable(),
    icon: exports.tableFullVoSchema.shape.icon.nullable(),
    fieldKeyType: record_1.fieldKeyTypeRoSchema,
    fields: core_1.createFieldRoSchema.array().optional().openapi({
        description: 'The fields of the table. If it is empty, 3 fields include SingleLineText, Number, SingleSelect will and 3 empty records be generated by default.',
    }),
    views: core_1.viewRoSchema.array().optional().openapi({
        description: 'The views of the table. If it is empty, a grid view will be generated by default.',
    }),
    records: record_1.createRecordsRoSchema.shape.records.optional().openapi({
        description: 'The record data of the table. If it is empty, 3 empty records will be generated by default.',
    }),
}))
    .openapi({
    description: 'params for create a table',
});
exports.tableRoWithDefaultSchema = exports.tableRoSchema.required({
    fields: true,
    views: true,
});
exports.tablePropertyKeySchema = exports.tableRoSchema.pick({
    name: true,
    dbTableName: true,
    description: true,
    icon: true,
    order: true,
});
exports.tableOpSchema = exports.tableVoSchema.pick({
    id: true,
    name: true,
    description: true,
    order: true,
    icon: true,
    lastModifiedTime: true,
});
exports.tableListVoSchema = exports.tableVoSchema.array().openapi({
    description: 'The list of tables.',
});
exports.CREATE_TABLE = '/base/{baseId}/table/';
exports.CreateTableRoute = (0, utils_1.registerRoute)({
    method: 'post',
    path: exports.CREATE_TABLE,
    summary: 'Create table',
    description: 'Create a new table in the specified base with customizable fields, views, and initial records. Default configurations will be applied if not specified.',
    request: {
        params: zod_1.z.object({
            baseId: zod_1.z.string(),
        }),
        body: {
            content: {
                'application/json': {
                    schema: exports.tableRoSchema,
                },
            },
        },
    },
    responses: {
        201: {
            description: 'Returns data about a table.',
            content: {
                'application/json': {
                    schema: exports.tableFullVoSchema,
                },
            },
        },
    },
    tags: ['table'],
});
const createTable = async (baseId, tableRo = {}) => {
    return axios_1.axios.post((0, utils_1.urlBuilder)(exports.CREATE_TABLE, { baseId }), tableRo);
};
exports.createTable = createTable;
