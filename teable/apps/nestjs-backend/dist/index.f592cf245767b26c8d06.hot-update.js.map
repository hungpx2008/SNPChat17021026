{"version":3,"file":"index.f592cf245767b26c8d06.hot-update.js","mappings":";;;;;;;;;;;AAAa;AACb;AACA;AACA;AACA,6CAA6C,QAAQ;AACrD;AACA;AACA;AACA,8CAA6C,EAAE,aAAa,EAAC;AAC7D,qBAAqB;AACrB,iBAAiB,mBAAO,CAAC,sCAAgB;AACzC,iBAAiB,mBAAO,CAAC,sCAAgB;AACzC,iBAAiB,mBAAO,CAAC,sBAAQ;AACjC,gBAAgB,mBAAO,CAAC,2DAAS;AACjC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oBAAoB;AACpB;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA,oBAAoB;AACpB;AACA;AACA;AACA,oBAAoB;AACpB;AACA;AACA,yEAAyE,IAAI;AAC7E;AACA;AACA;AACA,qEAAqE,sBAAsB,cAAc,sBAAsB,2CAA2C,uCAAuC,gCAAgC,wCAAwC;AACzR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6CAA6C,wCAAwC;AACrF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B,YAAY;AACzC,aAAa;AACb,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB,qBAAqB;AACrB;AACA;;;;;;;;;;UCrJA","sources":["webpack://@teable/backend/../../packages/db-main-prisma/src/prisma.service.ts","webpack://@teable/backend/webpack/runtime/getFullHash"],"sourcesContent":["\"use strict\";\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar PrismaService_1;\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.PrismaService = void 0;\nconst common_1 = require(\"@nestjs/common\");\nconst client_1 = require(\"@prisma/client\");\nconst nanoid_1 = require(\"nanoid\");\nconst utils_1 = require(\"./utils\");\nfunction proxyClient(tx) {\n    return new Proxy(tx, {\n        get(target, p) {\n            if (p === '$queryRawUnsafe' || p === '$executeRawUnsafe') {\n                return async function (query, ...args) {\n                    try {\n                        return await target[p](query, ...args);\n                    }\n                    catch (e) {\n                        if (e instanceof client_1.Prisma.PrismaClientKnownRequestError && e.code === 'P2028') {\n                            throw new utils_1.TimeoutHttpException();\n                        }\n                        throw e;\n                    }\n                };\n            }\n            return target[p];\n        },\n    });\n}\nlet PrismaService = PrismaService_1 = class PrismaService extends client_1.PrismaClient {\n    cls;\n    logger = new common_1.Logger(PrismaService_1.name);\n    afterTxCb;\n    // Default transaction options from environment variables\n    // Prisma's built-in defaults: timeout=5000ms, maxWait=2000ms\n    defaultTxTimeout = PrismaService_1.parseOrDefault(process.env.PRISMA_TRANSACTION_TIMEOUT, process.env.NODE_ENV === 'production' ? 5000 : 20000);\n    defaultTxMaxWait = PrismaService_1.parseOrDefault(process.env.PRISMA_TRANSACTION_MAX_WAIT, process.env.NODE_ENV === 'production' ? 2000 : 5000);\n    constructor(cls) {\n        const logConfig = {\n            log: [\n                // {\n                //   level: 'query',\n                //   emit: 'event',\n                // },\n                {\n                    level: 'error',\n                    emit: 'stdout',\n                },\n                // {\n                //   level: 'info',\n                //   emit: 'stdout',\n                // },\n                // {\n                //   level: 'warn',\n                //   emit: 'stdout',\n                // },\n            ],\n        };\n        const initialConfig = process.env.NODE_ENV === 'production' ? {} : { ...logConfig };\n        super(initialConfig);\n        this.cls = cls;\n        // Log transaction timeout configuration on startup (must be after super())\n        console.log(`[PrismaService] Transaction defaults: timeout=${this.defaultTxTimeout}ms, maxWait=${this.defaultTxMaxWait}ms (from env: PRISMA_TRANSACTION_TIMEOUT=${process.env.PRISMA_TRANSACTION_TIMEOUT}, PRISMA_TRANSACTION_MAX_WAIT=${process.env.PRISMA_TRANSACTION_MAX_WAIT})`);\n    }\n    static parseOrDefault(value, fallback) {\n        const parsed = Number(value);\n        if (Number.isFinite(parsed) && parsed > 0) {\n            return parsed;\n        }\n        return fallback;\n    }\n    bindAfterTransaction(fn) {\n        this.afterTxCb = fn;\n    }\n    /**\n     * Executes a transaction using the provided function and options.\n     * If a transaction client is already defined in the current context, the function is executed using it.\n     * Otherwise, a new transaction is created and the function is executed using it.\n     * @param fn The function to execute within the transaction.\n     * @param options The options to use when creating the transaction.\n     * @returns The result of the executed function.\n     */\n    async $tx(fn, options) {\n        let result = undefined;\n        const txClient = this.cls.get('tx.client');\n        if (txClient) {\n            return await fn(txClient);\n        }\n        // Apply default timeout and maxWait from environment if not explicitly provided\n        const txOptions = {\n            timeout: options?.timeout ?? this.defaultTxTimeout,\n            maxWait: options?.maxWait ?? this.defaultTxMaxWait,\n            ...(options?.isolationLevel && { isolationLevel: options.isolationLevel }),\n        };\n        await this.cls.runWith(this.cls.get(), async () => {\n            result = await super.$transaction(async (prisma) => {\n                prisma = proxyClient(prisma);\n                this.cls.set('tx.client', prisma);\n                this.cls.set('tx.id', (0, nanoid_1.nanoid)());\n                this.cls.set('tx.timeStr', new Date().toISOString());\n                try {\n                    // can not delete await here\n                    return await fn(prisma);\n                }\n                finally {\n                    this.cls.set('tx.client', undefined);\n                    this.cls.set('tx.id', undefined);\n                    this.cls.set('tx.timeStr', undefined);\n                }\n            }, txOptions);\n            this.afterTxCb?.();\n        });\n        return result;\n    }\n    txClient() {\n        const txClient = this.cls.get('tx.client');\n        if (!txClient) {\n            // console.log('transactionId', 'none');\n            return this;\n        }\n        // const id = this.cls.get('tx.id');\n        // console.log('transactionId', id);\n        return txClient;\n    }\n    async onModuleInit() {\n        await this.$connect();\n        if (process.env.NODE_ENV === 'production')\n            return;\n        this.$on('query', async (e) => {\n            this.logger.debug({\n                // Query: e.query.trim().replace(/\\s+/g, ' ').replace(/\\( /g, '(').replace(/ \\)/g, ')'),\n                Query: e.query,\n                Params: e.params,\n                Duration: `${e.duration} ms`,\n            });\n        });\n    }\n    async onModuleDestroy() {\n        await this.$disconnect();\n    }\n};\nexports.PrismaService = PrismaService;\nexports.PrismaService = PrismaService = PrismaService_1 = __decorate([\n    (0, common_1.Injectable)()\n], PrismaService);\n","__webpack_require__.h = () => (\"f1d3274a967a0edefc94\")"],"names":[],"sourceRoot":""}